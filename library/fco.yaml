imports:
  - http://dice-project.github.io/DICE-FCO-Plugin-Cloudify/0.1.1/plugin.yaml


inputs:

  centos_agent_user:
    description: >-
      User that can be used to login to CentOS cloud image (by default, this
      is set to centos, but can be changed if required).
    default: centos

  ubuntu_agent_user:
    description: >-
      User that can be used to login to Ubuntu cloud image (by default, this
      is set to ubuntu, but can be changed if required).
    default: ubuntu

  centos_image_id:
    description: >-
      OpenStack id of the CentOS image that should be used on CentOS instances.

  ubuntu_image_id:
    description: >-
      OpenStack id of the Ubuntu image that should be used on Ubuntu instances.

  small_server_type:
    description: FCO server type that should be used on small instances.
  small_disk:
    description: FCO disk that should be used on small instances.

  medium_server_type:
    description: FCO server type that should be used on medium instances.
  medium_disk:
    description: FCO disk that should be used on medium instances.

  large_server_type:
    description: FCO server type that should be used on large instances.
  large_disk:
    description: FCO disk that should be used on large instances.

  # TODO: This should be set on manager on bootstrap, but FCO plugin does not
  # support such functionality yet.
  username:
    description: FCO username (UUID).
  password:
    description: FCO password.
  customer:
    description: FCO customer (UUID).
  service_url:
    description: FCO REST service base url.
  agent_key:
    description: UUID of the key that should be used by plugin.
  vdc:
    description: UUID of the VDC that should be used to create instances.
  network:
    description: UUID of the network that instances should be connected to.


node_types:

  dice.firewall_rules.Base:
    derived_from: dice.firewall_rules.Unimplemented
    properties:
      # In order to support creating custom firewalls in blueprints, rules
      # property needs to be present. Note that this has been added only to
      # ensure compatibility with blueprints written for OpenStack.
      rules:
        default: []

  # Dummy floating IP that simply holds copy of VM's IP address
  dice.VirtualIP:
    derived_from: cloudify.nodes.Root

  dice.hosts.Custom:
    derived_from: cloudify.flexiant.nodes.Server
    properties:
      auth:
        default:
          username: { get_input: username }
          password: { get_input: password }
          customer: { get_input: customer }
          url: { get_input: service_url }
          verify_ca_cert: False
      agent_key:
        default: { get_input: agent_key }
      vdc:
        default: { get_input: vdc }
      network:
        default: { get_input: network }

  # CentOS hosts
  dice.hosts.centos.Custom:
    derived_from: dice.hosts.Custom
    properties:
      image: { default: { get_input: centos_image_id } }
      cloudify_agent:
        default:
          user: { get_input: centos_agent_user }
          key: /root/.ssh/agent.key


  dice.hosts.centos.Small:
    derived_from: dice.hosts.centos.Custom
    properties:
      server_type: { default: { get_input: small_server_type } }
      disk:        { default: { get_input: small_disk        } }

  dice.hosts.centos.Medium:
    derived_from: dice.hosts.centos.Custom
    properties:
      server_type: { default: { get_input: medium_server_type } }
      disk:        { default: { get_input: medium_disk        } }

  dice.hosts.centos.Large:
    derived_from: dice.hosts.centos.Custom
    properties:
      server_type: { default: { get_input: large_server_type } }
      disk:        { default: { get_input: large_disk        } }

  # Ubuntu hosts
  dice.hosts.ubuntu.Custom:
    derived_from: dice.hosts.Custom
    properties:
      image: { default: { get_input: ubuntu_image_id } }
      cloudify_agent:
        default:
          user: { get_input: ubuntu_agent_user }
          key: /root/.ssh/agent.key

  dice.hosts.ubuntu.Small:
    derived_from: dice.hosts.ubuntu.Custom
    properties:
      server_type: { default: { get_input: small_server_type } }
      disk:        { default: { get_input: small_disk        } }

  dice.hosts.ubuntu.Medium:
    derived_from: dice.hosts.ubuntu.Custom
    properties:
      server_type: { default: { get_input: medium_server_type } }
      disk:        { default: { get_input: medium_disk        } }

  dice.hosts.ubuntu.Large:
    derived_from: dice.hosts.ubuntu.Custom
    properties:
      server_type: { default: { get_input: large_server_type } }
      disk:        { default: { get_input: large_disk        } }


  # Backwards compatibility - remove after some grace period
  dice.hosts.Small:
    derived_from: dice.hosts.ubuntu.Small
  dice.hosts.Medium:
    derived_from: dice.hosts.ubuntu.Medium
  dice.hosts.Large:
    derived_from: dice.hosts.ubuntu.Large


relationships:

  dice.relationships.ProtectedBy:
    derived_from: dice.relationships.Unimplemented

  # When connection is established, we copy address from VM. This may seem
  # a bit backwards at first, but things are done this way in order to be
  # consistent with OpenStack and Amazon way of doing things.
  dice.relationships.IPAvailableFrom:
    derived_from: cloudify.relationships.connected_to
    target_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        establish:
          implementation: dice.dice_plugin.tasks.base.copy_ip_from_source
          executor: central_deployment_agent
          inputs:
            property: { default: floating_ip_address }
