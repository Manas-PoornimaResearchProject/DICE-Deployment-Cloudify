# Apache Cassandra

node_types:

  dice.components.cassandra.Base:
    derived_from: dice.chef.SoftwareComponent
    properties:
      # NOTE to developers: This property is not defined on root DICE types
      # because not all types support monitoring and specifying thing on a
      # more granular level gives blueprint validator additional leverage
      # when performing checks.
      monitoring:
        type: dice.types.MonitoringConfig
      create_runlist:
        default:
          - recipe[apt::default]
          - recipe[dice_common::default]
          - recipe[java::default]
          - recipe[cassandra::default]
          - recipe[dmon_agent::default]
          - recipe[dmon_agent::collectd]
      configure_runlist:
        default:
          - recipe[cassandra::configure]
      start_runlist:
        default:
          - recipe[cassandra::start]
          - recipe[dmon_agent::cassandra]
      chef_attributes:
        default:
          java:
            jdk_version:    { get_input: java_version }
            install_flavor: { get_input: java_flavor  }

  # Next two types are present here to make it possible to change them in the
  # future without breaking our consumers
  dice.components.cassandra.Seed:
    derived_from: dice.components.cassandra.Base

  dice.components.cassandra.Worker:
    derived_from: dice.components.cassandra.Base


  # Firewall rules that are needed for proper communication in cassandra
  dice.firewall_rules.cassandra.Common:
    derived_from: dice.firewall_rules.Base
    properties:
      rules:
        default:
          - remote_ip_prefix: 0.0.0.0/0
            port: 7000
          - remote_ip_prefix: 0.0.0.0/0
            port: 7001
          - remote_ip_prefix: 0.0.0.0/0
            port: 7199
          - remote_ip_prefix: 0.0.0.0/0
            port: 9042
          - remote_ip_prefix: 0.0.0.0/0
            port: 9160

  # Next two are present only for convenience, since it may be easier for
  # generator to generate firewall rules that correspond 1:1 onto TOSCA types.
  dice.firewall_rules.cassandra.Seed:
    derived_from: dice.firewall_rules.cassandra.Common

  dice.firewall_rules.cassandra.Worker:
    derived_from: dice.firewall_rules.cassandra.Common


relationships:

  dice.relationships.cassandra.ConnectedToSeed:
    derived_from: cloudify.relationships.connected_to
    properties:
      connection_type: { default: all_to_one }
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: dice.dice_plugin.tasks.cassandra.gather_seeds
