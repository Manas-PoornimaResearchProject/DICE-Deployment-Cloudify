# Apache Storm

node_types:

  dice.components.storm.Worker:
    derived_from: dice.chef.SoftwareComponent
    properties:
      configure_runlist:
        default:
          - recipe[apt::default@2.9.2]
          - recipe[java::default@1.36.0]
          - recipe[storm-cluster::supervisor@0.0.24]
          - recipe[storm-cluster::configure@0.0.24]
      start_runlist:
        default:
          - recipe[storm-cluster::start@0.0.24]
      chef_attributes: &STORM_CHEF_ATTRS
        default:
          storm:
            install_method: remote_file
            download_url: http://193.77.50.17/

  dice.components.storm.Nimbus:
    derived_from: dice.chef.SoftwareComponent
    properties:
      configure_runlist:
        default:
          - recipe[apt::default@2.9.2]
          - recipe[java::default@1.36.0]
          - recipe[storm-cluster::nimbus@0.0.24]
          - recipe[storm-cluster::supervisor@0.0.24]
          - recipe[storm-cluster::configure@0.0.24]
      start_runlist:
        default:
          - recipe[storm-cluster::start@0.0.24]
      chef_attributes: *STORM_CHEF_ATTRS

  dice.components.storm.Topology:
    derived_from: cloudify.nodes.Root
    properties:
      configuration:
        description: >
          Storm configuration values that should be set for this topology
          (this will be passed to nimbus at submission time). This
          configuration will be merged with storm cluster configration.
        default: {}
      application:
        description: >
          Location of topology jar file. If this is relative path, file is
          assumed to be part of the blueprint package. If this URL, file will
          be downloaded.
      topology_name:
        description: >
          Topology name (this name will be seen in Storm UI)
      topology_class:
        description: >
          Class name that contains Storm topology


relationships:

  dice.relationships.storm.ConnectedToZookeeperQuorum:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: dice.dice_plugin.tasks.base.copy_runtime_prop
          inputs:
            property: { default: zookeeper_quorum }

  dice.relationships.storm.ConnectedToNimbus:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: dice.dice_plugin.tasks.base.copy_ip_address
          inputs:
            property: { default: storm_nimbus_ip }

  dice.relationships.storm.SubmittedBy:
    derived_from: cloudify.relationships.connected_to
    properties:
      connection_type: { default: all_to_one }
    target_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        postconfigure:
          implementation: dice.dice_plugin.tasks.storm.submit_topology
          inputs:
            jar:   { default: { get_property: [ SOURCE, application    ] } }
            name:  { default: { get_property: [ SOURCE, topology_name  ] } }
            klass: { default: { get_property: [ SOURCE, topology_class ] } }
