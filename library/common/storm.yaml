# Apache Storm

node_types:

  dice.components.storm.Worker:
    derived_from: dice.chef.SoftwareComponent
    properties:
      configure_runlist:
        default:
          - recipe[apt::default@2.9.2]
          - recipe[java::default@1.36.0]
          - recipe[storm-cluster::common@0.0.25]
          - recipe[storm-cluster::configure@0.0.25]
      start_runlist:
        default:
          - recipe[storm-cluster::start_supervisor@0.0.25]

  dice.components.storm.Nimbus:
    derived_from: dice.chef.SoftwareComponent
    properties:
      configure_runlist:
        default:
          - recipe[apt::default@2.9.2]
          - recipe[java::default@1.36.0]
          - recipe[storm-cluster::common@0.0.25]
          - recipe[storm-cluster::configure@0.0.25]
      start_runlist:
        default:
          - recipe[storm-cluster::start_nimbus@0.0.25]
          - recipe[storm-cluster::start_supervisor@0.0.25]

  dice.components.storm.Topology:
    derived_from: dice.LogicalNode
    properties:
      application:
        description: >
          Location of topology jar file. If this is relative path, file is
          assumed to be part of the blueprint package. If this URL, file will
          be downloaded.
      topology_name:
        description: >
          Topology name (this name will be seen in Storm UI)
      topology_class:
        description: >
          Class name that contains Storm topology
    interfaces:
      cloudify.interfaces.lifecycle:
        start:
          implementation: dice.dice_plugin.tasks.storm.submit_topology
          inputs:
            jar:   { default: { get_property: [ SELF, application    ] } }
            name:  { default: { get_property: [ SELF, topology_name  ] } }
            klass: { default: { get_property: [ SELF, topology_class ] } }
        stop:
          implementation: dice.dice_plugin.tasks.storm.kill_topology
          inputs:
            name: { default: { get_property: [ SELF, topology_name  ] } }

  # Firewall rules
  dice.firewall_rules.storm.Nimbus:
    derived_from: dice.firewall_rules.Base
    properties:
      rules:
        default:
          - remote_ip_prefix: 0.0.0.0/0
            port: 6627
          - remote_ip_prefix: 0.0.0.0/0
            port: 8080
          - remote_ip_prefix: 0.0.0.0/0
            port_range_min: 6700
            port_range_max: 6703
          - remote_ip_prefix: 0.0.0.0/0
            port: 3773
          - remote_ip_prefix: 0.0.0.0/0
            port: 3774

  dice.firewall_rules.storm.Worker:
    derived_from: dice.firewall_rules.Base
    properties:
      rules:
        default:
          - remote_ip_prefix: 0.0.0.0/0
            port_range_min: 6700
            port_range_max: 6703
          - remote_ip_prefix: 0.0.0.0/0
            port: 3773
          - remote_ip_prefix: 0.0.0.0/0
            port: 3774


relationships:

  dice.relationships.storm.ConnectedToZookeeperQuorum:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: dice.dice_plugin.tasks.base.copy_runtime_prop
          inputs:
            property: { default: zookeeper_quorum }

  dice.relationships.storm.ConnectedToNimbus:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: dice.dice_plugin.tasks.base.copy_ip_from_target
          inputs:
            property: { default: storm_nimbus_ip }

  dice.relationships.storm.SubmittedBy:
    derived_from: cloudify.relationships.contained_in
    properties:
      connection_type: { default: all_to_one }
