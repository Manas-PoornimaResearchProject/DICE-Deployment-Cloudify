# Apache zookeeper

node_types:

  dice.components.zookeeper.Server:
    derived_from: dice.chef.SoftwareComponent
    properties:
      create_runlist:
        default:
          - recipe[dice_common::host]
          - recipe[apt::default]
          - recipe[java::default]
          - recipe[zookeeper::default]
      configure_runlist:
        default:
          - recipe[zookeeper::configure]
      start_runlist:
        default:
          - recipe[zookeeper::start]

  dice.components.zookeeper.Quorum:
    derived_from: cloudify.nodes.Root
    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: dice.dice_plugin.tasks.zookeeper.merge_config
          executor: central_deployment_agent

  # Firewall rules
  dice.firewall_rules.zookeeper.Server:
    derived_from: dice.firewall_rules.Base
    properties:
      rules:
        default:
          - remote_ip_prefix: 0.0.0.0/0
            port: 2181
          - remote_ip_prefix: 0.0.0.0/0
            port: 2888
          - remote_ip_prefix: 0.0.0.0/0
            port: 3888


relationships:

  dice.relationships.zookeeper.QuorumContains:
    derived_from: cloudify.relationships.depends_on
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: dice.dice_plugin.tasks.zookeeper.gather_config
          executor: central_deployment_agent
          max_retries: -1
          retry_interval: 2

  dice.relationships.zookeeper.MemberOfQuorum:
    derived_from: cloudify.relationships.depends_on
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: dice.dice_plugin.tasks.base.copy_runtime_prop
          inputs:
            property: { default: zookeeper_quorum }
