# Apache Zookeeper
# ================

node_types:

  dice.components.zookeeper.Server:
    derived_from: dice.chef.SoftwareComponent
    properties:
      create_runlist:
        default:
          - recipe[apt::default]
          - recipe[dice_common::default]
          - recipe[java::default]
          - recipe[zookeeper::default]
      configure_runlist:
        default:
          - recipe[zookeeper::configure]
      start_runlist:
        default:
          - recipe[zookeeper::start]
      chef_attributes:
        default:
          java:
            jdk_version:    { get_input: java_version }
            install_flavor: { get_input: java_flavor  }

  dice.components.zookeeper.Quorum:
    derived_from: cloudify.nodes.Root
    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: dice.dice_plugin.tasks.base.collect_data_for_rel
          executor: central_deployment_agent
          inputs:
            rel_type: { default: dice.relationships.zookeeper.QuorumContains }
            dest_attr: { default: zookeeper_quorum }
            selector: { default: { attributes: { ip: ip } } }
            container: { default: list }

  # Firewall rules
  dice.firewall_rules.zookeeper.Server:
    derived_from: dice.firewall_rules.Base
    properties:
      rules:
        default:
          - ip_prefix: 0.0.0.0/0
            protocol: tcp
            port: 2181
          - ip_prefix: 0.0.0.0/0
            protocol: tcp
            port: 2888
          - ip_prefix: 0.0.0.0/0
            protocol: tcp
            port: 3888


relationships:

  dice.relationships.zookeeper.QuorumContains:
    derived_from: cloudify.relationships.depends_on

  dice.relationships.zookeeper.MemberOfQuorum:
    derived_from: cloudify.relationships.depends_on
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: dice.dice_plugin.tasks.base.copy_attr_from_target
          inputs:
            source_name: { default: zookeeper_quorum }
            target_name: { default: zookeeper_quorum }

  dice.relationships.zookeeper.ConnectedToZookeeperQuorum:
    derived_from: dice.relationships.zookeeper.MemberOfQuorum
